import time
import adafruit_dht
import board
import paho.mqtt.client as mqtt

# Function to publish data to MQTT broker
def publish_to_mqtt(topic, message):
    client.publish(topic, message)

# Callback function when connection is established
def on_connect(client, userdata, flags, rc):
    print("Connected with result code "+str(rc))

# Create an MQTT client instance
client = mqtt.Client()

# Assign callback functions
client.on_connect = on_connect

# Connect to MQTT broker
client.connect("test.mosquitto.org", 1883, 60)

dht_device = adafruit_dht.DHT11(board.D4)

while True:
    try:
        temperature_c = dht_device.temperature
        temperature_f = temperature_c * (9 / 5) + 32

        humidity = dht_device.humidity

        print("Temp:{:.1f} C / {:.1f} F    Humidity: {}%".format(temperature_c, temperature_f, humidity))

        # Publish temperature and humidity data to MQTT topics
        publish_to_mqtt("home/temperature", "Temperature: {:.1f} C / {:.1f} F".format(temperature_c, temperature_f))
        publish_to_mqtt("home/humidity", "Humidity: {}%".format(humidity))

        time.sleep(2.0)
    except RuntimeError as err:
        print(err.args[0])
        time.sleep(2.0)
